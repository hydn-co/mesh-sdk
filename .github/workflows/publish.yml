name: Publish

on:
  workflow_dispatch:

permissions:
  contents: write
  packages: read

jobs:
  version:
    name: Version
    uses: ./.github/workflows/version.yml
    secrets: inherit

  build:
    name: Build and Test
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  publish:
    name: Publish and Notify Go Proxy
    needs: [version, build]
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Tag Commit
        uses: hydn-co/build-tools/.github/actions/create-tag@main
        with:
          semver: ${{ needs.version.outputs.semVer }}
        continue-on-error: true

      - name: Trigger Go package registry
        env:
          MODULE_PATH: github.com/hydn-co/mesh-sdk
          VERSION: ${{ needs.version.outputs.semVer }}
        run: |
          echo "Triggering Go proxy for ${MODULE_PATH}@${VERSION}"
          # Request module info to prompt Go proxies to fetch the new version
          curl -sf "https://proxy.golang.org/${MODULE_PATH}/@v/${VERSION}.info" -o /dev/null || true
